<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç»’èŠ±å¸ƒè‰²æ­é…ï¼ˆåŒä¾§è¾¹æ‹–æ‹½åŒºï¼‰</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background-color: #f0e6d2;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding-top: env(safe-area-inset-top);
      padding: 20px;
      overflow-y: auto;
      overflow-x: hidden;
    }

    .page-container {
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      width: 640px;
      min-height: 100vh;
      position: relative;
    }
    .main-page {
      display: block;
      width: 100%;
      position: relative;
    }
    .result-page {
      display: none;
      width: 100%;
      min-height: 100vh;
      overflow: visible;
      position: relative;
    }

    .bg-container {
      width: 640px;
      height: 1030px;
      position: relative;
      background: url("./dipian.jpg") no-repeat 0 0;
      background-size: 640px 1030px;
      flex-shrink: 0;
      margin-bottom: 20px;
      z-index: 1;
    }

    /* ========== éŸ³ä¹å›¾æ ‡æ ·å¼ - ä¿®æ”¹ä¸ºç›¸å¯¹äºèƒŒæ™¯å›¾ç‰‡ ========== */
    .music-icon {
      position: absolute; /* ä¿®æ”¹ä¸ºabsoluteå®šä½ï¼Œç›¸å¯¹äº.bg-container */
      top: 25px; /* è°ƒæ•´ä½ç½® */
      right: 25px;
      width: 50px;
      height: 50px;
      background: url("./music.png") no-repeat center;
      background-size: contain;
      z-index: 9999; /* è®¾ç½®ä¸ºæé«˜çš„å±‚çº§ï¼Œç¡®ä¿å§‹ç»ˆåœ¨æœ€ä¸Šå±‚ */
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .music-icon:hover {
      transform: scale(1.1);
    }

    .music-icon.music1 {
      background: url("./music1.png") no-repeat center;
      background-size: contain;
    }

    .next-img {
      position: absolute;
      top: 685px; 
      right: 20px; 
      width: 150px;
      height: 75px;
      z-index: 1999;
      cursor: pointer;
      background: url("./next.png") no-repeat center;
      background-size: 100% 100%;
    }

    .trigger-wrapper {
      position: absolute;
      width: 640px;
      height: 1030px;
      z-index: 999;
      pointer-events: auto;
    }
    .trigger-side-1 {
      position: absolute;
      top: 360px;    
      left: 180px;   
      width: 70px;   
      height: 303px; 
      border-radius: 4px;
      pointer-events: auto;
    }
    .trigger-side-2 {
      position: absolute;
      top: 360px;    
      right: 175px;   
      width: 70px;   
      height: 303px; 
      border-radius: 4px;
      pointer-events: auto;
    }
    .trigger-middle {
      position: absolute;
      top: 355px;    
      left: 255px;   
      width: 140px;  
      height: 310px; 
      border-radius: 4px;
      pointer-events: auto;
    }

    .show-wrapper {
      position: absolute;
      width: 640px;
      height: 1030px;
      z-index: 998;
    }
    .show-side {
      position: absolute;
      top: 355px;    
      left: 168px;   
      width: 312px;  
      height: 306px; 
      opacity: 0;
      transition: opacity 0.2s ease-out;
      background-position: 0 0 !important;
      background-size: 100% 100% !important;
      background-repeat: no-repeat !important;
      z-index: 2;
    }
    .show-middle {
      position: absolute;
      top: 355px;    
      left: 168px;   
      width: 312px;  
      height: 306px; 
      opacity: 0;
      transition: opacity 0.2s ease-out;
      background-position: 0 0 !important;
      background-size: 100% 100% !important;
      background-repeat: no-repeat !important;
      z-index: 1;
    }
    .show-active {
      opacity: 1 !important;
      box-shadow: 0 0 8px rgba(0,0,0,0.2);
    }

    .thread-wrapper {
      position: absolute;
      bottom: 80px;
      left: 80px;
      width: 480px;
      height: 120px;
      z-index: 1000;
    }
    .thread {
      width: 100px;
      height: 100px;
      cursor: grab !important;
      border-radius: 8px;
      background-position: center;
      background-size: cover;
      background-repeat: no-repeat;
      transition: transform 0.2s ease;
      user-select: none;
      -webkit-user-drag: element;
      position: absolute;
      transform: scale(1);
      border: 2px solid transparent !important;
    }

    .thread-yellow {
      background-image: url("./yellow line.png") !important;
      left: 5px;
      top: 50px;
    }
    .thread-pink {
      background-image: url("./pink line.png") !important;
      left: 190px;
      top: 0px;
    }
    .thread-purple {
      background-image: url("./purple line.png") !important;
      left: 370px;
      top: 50px;
    }

    .thread:active {
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      border-width: 3px !important;
      transform: scale(0.95) !important;
    }

    .side-yellow { background-image: url("./yellow side.png") !important; }
    .side-pink { background-image: url("./pink side.png") !important; }
    .side-purple { background-image: url("./purple side.png") !important; }
    .middle-yellow { background-image: url("./yellow mid.png") !important; }
    .middle-pink { background-image: url("./pink mid.png") !important; }
    .middle-purple { background-image: url("./purple mid.png") !important; }

    .cover-touming {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: url("./touming.png") no-repeat center;
      background-size: 640px 1030px;
      z-index: 2000;
      pointer-events: auto;
      cursor: pointer;
    }

    .top-finger {
      position: absolute;
      top: 850px;
      left: 320px;
      width: 20%;
      height: 20%;
      background: url("./finger.png") no-repeat center;
      background-size: contain;
      z-index: 3000;
      pointer-events: none;
      opacity: 0;
      animation: fadeIn 1.5s ease-out forwards, handMove 1.5s ease-in-out infinite alternate;
    }

    .top-character {
      position: absolute;
      top: 0px;
      left: 160px;
      width: 50%;
      height: 50%;
      background: url("./character.png") no-repeat center;
      background-size: contain;
      z-index: 3000;
      pointer-events: none;
      opacity: 0;
      animation: fadeIn 1.5s ease-out 0.5s forwards;
    }
    
    .zi-image {
      position: absolute;
      top: 680px;
      left: 43%;
      transform: translateX(-50%);
      width: 200px;
      height: auto;
      z-index: 2;
      pointer-events: none;
    }
    
    /* ========== æ¢³ç»’æ­¥éª¤çš„é€æ˜æç¤ºå›¾ç‰‡ ========== */
    .shurong-hint {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: auto;
      opacity: 0;
      z-index: 12;
      display: none;
      pointer-events: none;
      transition: opacity 0.5s ease;
    }
    .shurong-hint.active {
      opacity: 0.5;
      display: block;
    }
    
    /* ========== æ¢³ç»’æ‰‹æŒ‡åŠ¨ç”» ========== */
    .shurong-finger {
      position: absolute;
      top: 150px;
      left: 50%;
      transform: translateX(-50%);
      width: 60px;
      height: 60px;
      background: url("./finger.png") no-repeat center;
      background-size: contain;
      z-index: 13;
      pointer-events: none;
      opacity: 0;
      display: none;
    }
    .shurong-finger.active {
      opacity: 1;
      display: block;
      animation: shurongFingerMove 1.5s ease-in-out infinite;
    }
    
    /* ========== ä¿®æ”¹é€æ˜å±‚æ ·å¼ ========== */
    .result-cover-touming {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      
      /* å…³é”®ï¼šç¡®ä¿é€æ˜å±‚æœ¬èº«æ˜¾ç¤ºä¸”ä¸éšè—å­å…ƒç´  */
      display: block;
      visibility: visible !important;
      opacity: 1 !important;
      
      background: url("./touming.png") no-repeat center;
      background-size: cover;
      z-index: 2001;
      pointer-events: auto;
      cursor: pointer;
      
      /* ç§»é™¤display:noneï¼Œç”¨opacityæ§åˆ¶æ˜¾ç¤º/éšè— */
      /* display: none; */  /* åˆ é™¤è¿™è¡Œ */
    }
	/* ========== zi2å›¾ç‰‡æœ€ç»ˆæ ·å¼ ========== */
	#resultCoverTouming .zi2-image {
	  /* å®šä½ - å±…ä¸­æ˜¾ç¤º */
	  position: absolute;
	  top: calc(50% - 80px);
	  left: 50%;
	  transform: translate(-50%, -50%);
	  
	  /* å¦‚æœæ‚¨æƒ³è°ƒæ•´ä½ç½®ï¼Œæ¯”å¦‚å‘ä¸Šç§»åŠ¨ä¸€äº› */
	  /* top: calc(50% - 80px); */ /* å‘ä¸Šç§»åŠ¨80px */
	  
	  /* å°ºå¯¸ */
	  width: 300px;
	  height: auto;
	  max-width: 80%;
	  
	  /* æ˜¾ç¤º */
	  display: block;
	  opacity: 1;
	  visibility: visible;
	  
	  /* å±‚çº§ */
	  z-index: 2004;
	  
	  /* äº¤äº’ */
	  pointer-events: none;
	  
	  /* é‡è¦å£°æ˜ */
	  !important; /* æ‰€æœ‰å±æ€§éƒ½éœ€è¦æ—¶æ·»åŠ  */
	}
    
    /* ========== ç»“æœé¡µçš„æ‰‹æŒ‡åŠ¨ç”»ï¼ˆé¬ƒæ¯›åˆ·åˆ°ä¸­å¿ƒä¸¤ç‚¹æ¥å›ç§»åŠ¨ï¼‰ ========== */
    .result-finger {
      position: absolute;
      top: 850px;
      left: 320px;
      width: 20%;
      height: 20%;
      background: url("./finger.png") no-repeat center;
      background-size: contain;
      z-index: 2003;
      pointer-events: none;
      opacity: 0;
      display: none;
      /* ç§»é™¤åŸæ¥çš„animationï¼Œç”¨JSæ§åˆ¶ */
    }
    
    /* ç§»é™¤åŸæ¥çš„ resultFingerMove åŠ¨ç”» */
    /* 
    @keyframes resultFingerMove {
      0% {
        transform: translateY(0);
      }
      100% {
        transform: translateY(-400px);
      }
    }
    */
    
    /* æ·»åŠ æ–°çš„ä¸¤ç‚¹æ¥å›ç§»åŠ¨åŠ¨ç”» */
    @keyframes brushToCenterTwoPoints {
      0%, 100% {
        /* é¬ƒæ¯›åˆ·ä½ç½®ï¼ˆåº•éƒ¨ä¸­é—´åå·¦ï¼‰ */
        top: 850px;
        left: 100px;
        transform: scale(1);
      }
      50% {
        /* ä¸­å¿ƒä½ç½® */
        top: 400px;
        left: 320px;
        transform: scale(1.2);
      }
    }
    
    /* æˆ–è€…ä½¿ç”¨transformçš„ç‰ˆæœ¬ */
    @keyframes brushToCenterTransform {
      0%, 100% {
        /* èµ·å§‹ä½ç½® */
        transform: translate(0, 0);
      }
      50% {
        /* ç§»åŠ¨åˆ°ä¸­å¿ƒï¼šå‘å·¦ç§»åŠ¨220pxï¼Œå‘ä¸Šç§»åŠ¨450px */
        transform: translate(-220px, -450px);
      }
    }
    
    /* ä¿æŒå…¶ä»–åŠ¨ç”»ä¸å˜ */
    @keyframes shurongFingerMove {
      0% {
        transform: translateX(-50%) translateY(0);
      }
      50% {
        transform: translateX(-50%) translateY(60px);
      }
      100% {
        transform: translateX(-50%) translateY(0);
      }
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes handMove {
      from { transform: translateY(0); }
      to { transform: translateY(-400px); }
    }

    .hidden-all {
      display: none !important;
    }

    .result-bg-container {
      position: relative;
      width: 640px;
      height: 1030px;
      overflow: hidden;
      background: url("rh5/d27e008940a772bf5c6cb903c2a8ce53.jpg") no-repeat center center;
      background-size: cover;
      background-position: center 80%;
      padding: 20px;
      margin-bottom: 20px;
    }

    /* ä¸­å¿ƒå›¾ç‰‡å®¹å™¨ - ç»Ÿä¸€å®¹å™¨ */
    .center-img-wrapper {
      position: absolute;
      top: 9.5%;
      left: 50%;
      transform: translateX(-50%);
      width: 450px;
      height: auto;
      z-index: 10;
      pointer-events: auto; /* ç¡®ä¿å¯äº¤äº’ */
    }
    
    /* ========== 1. ä¸­å¿ƒåŸå§‹å›¾ç‰‡ ========== */
    .result-center-img {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: auto;
      opacity: 1;
      z-index: 10;
      transition: opacity 3s ease-in-out;
      display: block; /* ç¡®ä¿æ˜¾ç¤º */
    }
    .result-center-img.fade-out {
      opacity: 0 !important;
    }
    
    /* ========== 2. åç»­å›¾ç‰‡ï¼ˆafter-imgï¼‰ç‹¬ç«‹æ ·å¼ ========== */
    .after-img {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: auto;
      opacity: 0;
      z-index: 11;
      display: none;
      transition: opacity 3s ease-in-out;
    }
    .after-img.fade-in {
      opacity: 1 !important;
    }
    
    /* ========== 3. é“œä¸è¦†ç›–å›¾ç‰‡ç‹¬ç«‹æ ·å¼ ========== */
    .copper-overlay-img {
      position: absolute;
      top: 220px;
      left: 50%;
      transform: translateX(-50%);
      width: 220px;
      height: auto;
      opacity: 0;
      z-index: 12;
      display: none;
      transition: opacity 2s ease-in-out;
    }
    .copper-overlay-img.fade-in {
      opacity: 1 !important;
    }
    
    /* ========== 4. çº¿æ’å‰ªåç¬¬ä¸€ç±»å›¾ç‰‡ï¼ˆbeforeå›¾ç‰‡ï¼‰ ========== */
    .xianpaijian-before-img {
      position: absolute;
      top: 400px;
      left: -30%;
      width: 500px;
      height: 180px;
      opacity: 0;
      z-index: 13;
      display: none;
      transition: opacity 1s ease-in-out;
    }
    .xianpaijian-before-img.fade-in {
      opacity: 1 !important;
    }
    
    /* ========== 5. é€æ˜è§¦å‘åŒºåŸŸï¼ˆåœ¨beforeå›¾ç‰‡ä¹‹ä¸Šï¼‰ ========== */
    .trigger-area-transparent {
      position: absolute;
      top: 450px;
      left: 65%;
      transform: translateX(-50%);
      width: 250px;
      height: 300px;
      background-color: transparent;
      z-index: 60;
      display: none;
      cursor: pointer;
    }
    
    /* ========== 6. å¤§çº¿æ’å‰ªå›¾ç‰‡ ========== */
    .xianpaijian-big-img {
      position: absolute;
      top: 300px;
      left: 55%;
      transform:none;
      width: 100px;
      height: auto;
      opacity: 0;
      z-index: 70;
      display: none;
      cursor: grab;
      transition: opacity 0.5s ease, transform 0.3s ease;
      pointer-events: auto;
    }
    .xianpaijian-big-img.active {
      opacity: 1;
      display: block;
    }
    .xianpaijian-big-img.dragging {
      opacity: 0.7;
      transform: translateX(-50%) scale(0.95);
      cursor: grabbing;
    }
    
    /* ========== 7. æœ€ç»ˆå›¾ç‰‡ï¼ˆæ»‘åŠ¨åæ˜¾ç¤ºï¼‰ ========== */
    .final-img {
      position: absolute;
      top: 490px;
      left: 35%;
      transform: translateX(-50%);
      width: 500px;
      height: 180px;
      opacity: 0;
      z-index: 80;
      display: none;
      transition: opacity 1s ease-in-out;
    }
   
    .final-img.fade-in {
      opacity: 1 !important;
    }

    .result-yuanpan-img {
      position: absolute;
      bottom: -38%;
      left: 50%;
      transform: translateX(-50%);
      width: 105%;
      height: 105%;
      background: url("rh5/yuanpan.png") no-repeat center bottom;
      background-size: contain;
      z-index: 20;
    }

    .result-tool-wrapper {
      position: absolute;
      bottom: 5%;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      text-align: center;
      z-index: 30;
    }

    .result-tool-container {
      position: relative;
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      z-index: 30;
      transform-origin: bottom center;
    }

    .result-tool-container:nth-child(1) {
      transform: rotate(0deg) translate(-20px, 15px);
      margin-right: 5%;
      --rotate: -0deg;
      transition: transform 0.5s ease-out;
    }
    
    .result-tool-img {
      cursor: grab;
      transition: opacity 0.2s ease, transform 0.2s ease;
      display: block; /* ç¡®ä¿æ˜¾ç¤º */
      pointer-events: auto; /* ç¡®ä¿å¯äº¤äº’ */
    }
    
    .result-tool-img:active {
      opacity: 0.7 !important;
      transform: scale(0.98);
      cursor: grabbing;
    }
    
    .result-tool-container:nth-child(1) .result-tool-script {
      width: 70px;
      height: auto;
      margin-bottom: 8px;
      position: relative;
      left: -60px;
      top: 140px;
      transform: rotate(calc(var(--rotate) * -1));
    }
    .result-tool-container:nth-child(1) .result-tool-img {
      width: 120px;
      height: auto;
      position: relative;
      left: -15px;
      top: 30px;
      transform: rotate(calc(var(--rotate) * -1));
    }

    .result-tool-container:nth-child(2) {
      transform: rotate(0deg) translate(0, 0px);
      margin: 0 3%;
      --rotate: 0deg;
    }
    .result-tool-container:nth-child(2) .result-tool-script {
      width: 35px;
      height: auto;
      margin-bottom: 5px;
      position: relative;
      left: -70px;
      top: 10px;
      transform: rotate(calc(var(--rotate) * -1));
    }
    .result-tool-container:nth-child(2) .result-tool-img {
      width: 90px;
      height: auto;
      position: relative;
      left: 0px;
      top: -50px;
      transform: rotate(calc(var(--rotate) * -1));
    }

    .result-tool-container:nth-child(3) {
      transform: rotate(0deg) translate(15px, -8px);
      margin-left: 5%;
      --rotate: 0deg;
    }
    .result-tool-container:nth-child(3) .result-tool-script {
      width: 45px;
      height: auto;
      margin-bottom: 10px;
      position: relative;
      left: -50px;
      top: 60px;
      transform: rotate(calc(var(--rotate) * -1));
    }
    .result-tool-container:nth-child(3) .result-tool-img {
      width: 110px;
      height: auto;
      position: relative;
      left: -25px;
      top: 25px;
      transform: rotate(calc(var(--rotate) * -1));
    }

    .result-flower-fairy-img {
      position: absolute;
      bottom: 5%;
      left: 5%;
      width: 200px;
      height: auto;
      z-index: 25;
    }

    .result-shurong-img {
      position: absolute;
      top: 43%;
      left: 8%;
      transform: translateY(-50%);
      width: 70px;
      height: auto;
      z-index: 15;
      display: block; /* ç¡®ä¿æ˜¾ç¤º */
    }
    
    /* ç»“æœé¡µçš„ä¸‹ä¸€æ­¥æŒ‰é’® */
    .result-next-btn {
      position: absolute;
      top: 750px;
      right: 20px;
      width: 150px;
      height: 75px;
      z-index: 2000;
      cursor: pointer;
      background: url("./next.png") no-repeat center;
      background-size: 100% 100%;
      display: block; /* ç¡®ä¿æ˜¾ç¤º */
      pointer-events: auto; /* ç¡®ä¿å¯äº¤äº’ */
    }
    .result-next-btn.active {
      display: block;
    }
  </style>
</head>
<body>
  <div class="page-container">
    <div class="main-page" id="mainPage">
      <div class="bg-container">
        <!-- å°†éŸ³ä¹å›¾æ ‡ç§»åˆ°èƒŒæ™¯å›¾ç‰‡å®¹å™¨å†…ï¼Œé¡µé¢åŠ è½½æ—¶ç«‹å³æ˜¾ç¤º -->
        <div class="music-icon" id="mainMusicIcon"></div>
        
        <div class="next-img" id="nextImg"></div>
        <!-- å¸ƒæ–™ä¸‹æ–¹çš„å›¾ç‰‡ -->
        <div class="zi-image">
          <img src="./zi.png" alt="æç¤ºæ–‡å­—">
        </div>
        <div class="trigger-wrapper">
          <div class="trigger-side-1" id="triggerSide1"></div>
          <div class="trigger-side-2" id="triggerSide2"></div>
          <div class="trigger-middle" id="triggerMiddle"></div>
        </div>

        <div class="show-wrapper">
          <div class="show-side" id="showSide"></div>
          <div class="show-middle" id="showMiddle"></div>
        </div>

        <div class="thread-wrapper">
          <div class="thread thread-yellow" draggable="true" data-type="yellow"></div>
          <div class="thread thread-pink" draggable="true" data-type="pink"></div>
          <div class="thread thread-purple" draggable="true" data-type="purple"></div>
        </div>

        <div class="cover-touming" id="coverTouming">
		</div>
        <div class="top-finger" id="finger"></div>
        <div class="top-character" id="character"></div>
      </div>
    </div>

    <div class="result-page" id="resultPage">
      <div class="result-bg-container">
        <!-- ========== æ–°å¢ï¼šç»“æœé¡µé€æ˜è¦†ç›–å±‚å’Œæ‰‹æŒ‡ ========== -->
        <div class="result-cover-touming" id="resultCoverTouming">
			<img src="./zi2.png" alt="æç¤ºæ–‡å­—2" class="zi2-image" id="zi2Image">
		</div>
        <div class="result-finger" id="resultFinger"></div>
        
        <!-- ç»“æœé¡µçš„ä¸‹ä¸€æ­¥æŒ‰é’® -->
        <div class="result-next-btn" id="resultNextBtn" data-next-url="/ç»’èŠ±1/flower-6/index6.html"></div>
        
        <!-- ç»“æœé¡µçš„éŸ³ä¹å›¾æ ‡ -->
        <div class="music-icon" id="resultMusicIcon"></div>
        
        <!-- é‡æ„ä¸­å¿ƒå›¾ç‰‡åŒºåŸŸï¼Œæ·»åŠ å®¹å™¨ç”¨äºé‡å æ˜¾ç¤º -->
        <div class="center-img-wrapper">
          <img src="" alt="æ­é…ç»“æœ" class="result-center-img" id="resultCenterImg">
          <img src="" alt="åç»­å›¾ç‰‡" class="after-img" id="afterImg">
          <img src="" alt="é“œä¸è¦†ç›–" class="copper-overlay-img" id="copperOverlayImg">
          <img src="" alt="çº¿æ’å‰ªç¬¬ä¸€ç±»å›¾ç‰‡" class="xianpaijian-before-img" id="xianpaijianBeforeImg">
          <!-- ========== æ–°å¢ï¼šæ¢³ç»’æ­¥éª¤çš„é€æ˜æç¤ºå›¾ç‰‡ ========== -->
          <img src="./shurong-hint.png" alt="æ¢³ç»’æç¤º" class="shurong-hint" id="shurongHint">
          
          <!-- ========== æ–°å¢ï¼šæ¢³ç»’æ‰‹æŒ‡åŠ¨ç”» ========== -->
          <div class="shurong-finger" id="shurongFinger"></div>
        </div>

        <!-- é€æ˜è§¦å‘åŒºåŸŸï¼ˆåœ¨beforeå›¾ç‰‡ä¹‹ä¸Šï¼‰ -->
        <div class="trigger-area-transparent" id="triggerAreaTransparent"></div>
        
        <!-- å¤§çº¿æ’å‰ªå›¾ç‰‡ -->
        <img src="" alt="å¤§çº¿æ’å‰ª" class="xianpaijian-big-img" id="xianpaijianBigImg">
        
        <!-- æœ€ç»ˆå›¾ç‰‡ï¼ˆæ»‘åŠ¨åæ˜¾ç¤ºï¼‰ -->
        <img src="" alt="æœ€ç»ˆå›¾ç‰‡" class="final-img" id="finalImg">

        <img src="rh5/shurong.png" alt="ç»’èŠ±" class="result-shurong-img">

        <img src="rh5/flower-fairy.png" alt="èŠ±ç²¾çµ" class="result-flower-fairy-img">

        <div class="result-yuanpan-img"></div>

        <div class="result-tool-wrapper">
          <div class="result-tool-container" id="zongmaoshuaContainer">
            <img src="rh5/zongmaoshua-script.png" alt="æ£•æ¯›åˆ·æ–‡å­—" class="result-tool-script">
            <img src="rh5/zongmaoshua.png" alt="æ£•æ¯›åˆ·" class="result-tool-img" id="zongmaoshuaImg" draggable="true">
          </div>
          <div class="result-tool-container" id="tongsiContainer">
            <img src="rh5/tongsi-script.png" alt="é“œä¸æ–‡å­—" class="result-tool-script">
            <img src="rh5/tongsi.png" alt="é“œä¸" class="result-tool-img" id="tongsiImg" draggable="true">
          </div>
          <div class="result-tool-container" id="xianpaijianContainer">
            <img src="rh5/xianpaijian-script.png" alt="çº¿æ’å‰ªæ–‡å­—" class="result-tool-script">
            <img src="rh5/xianpaijian.png" alt="çº¿æ’å‰ª" class="result-tool-img" id="xianpaijianImg" draggable="true">
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    console.log('ğŸš€ é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹ç›‘å¬æ‹–æ‹½äº‹ä»¶');

    // ====================== éŸ³ä¹åŠŸèƒ½ä»£ç ï¼ˆæ·»åŠ åˆ°æœ€å‰é¢ï¼‰ ======================
    // 1. åˆ›å»ºéŸ³é¢‘å¯¹è±¡ï¼ˆå¤ç”¨ç¼“å­˜ï¼‰
    let audio = new Audio('music.mp3');
    audio.loop = true;
    audio.volume = 0.8;
    // è¯»å–ä¸Šä¸€ä¸ªé¡µé¢ä¼ é€’çš„çŠ¶æ€ï¼ˆæ— åˆ™é»˜è®¤æš‚åœï¼‰
    let audioState = JSON.parse(localStorage.getItem('audioState') || '{"isPlaying":false,"icon":"music.png","currentTime":0}');

    // 2. DOMåŠ è½½å®Œæˆç«‹å³ç»­æ’­
    document.addEventListener('DOMContentLoaded', function() {
      // æ¢å¤ä»ä¸Šä¸ªé¡µé¢å¸¦æ¥çš„è¿›åº¦
      if (audioState.currentTime) {
        audio.currentTime = audioState.currentTime;
      }
      // è‡ªåŠ¨ç»­æ’­ï¼ˆå‡å°‘åœé¡¿ï¼‰
      if (audioState.isPlaying) {
        setTimeout(() => {
          audio.play().catch(err => {
            // æµè§ˆå™¨ç¦æ­¢è‡ªåŠ¨æ’­æ”¾æ—¶ï¼Œç‚¹å‡»åç›´æ¥åˆ‡æ¢
            console.log('éœ€ç‚¹å‡»å›¾æ ‡æ’­æ”¾éŸ³ä¹');
          });
        }, 0);
      }
      
      // æ ¹æ®çŠ¶æ€è®¾ç½®éŸ³ä¹å›¾æ ‡
      if (audioState.icon.includes('music1.png')) {
        mainMusicIcon.classList.add('music1');
        resultMusicIcon.classList.add('music1');
      } else {
        mainMusicIcon.classList.remove('music1');
        resultMusicIcon.classList.remove('music1');
      }
    });

    // 3. éŸ³ä¹å›¾æ ‡ç‚¹å‡»äº‹ä»¶
    function setupMusicIcon(musicIcon) {
      if (!musicIcon) return;
      
      musicIcon.addEventListener('click', function(e) {
        e.stopPropagation();
        
        // åˆ‡æ¢å›¾æ ‡
        this.classList.toggle('music1');
        
        if (audio.paused) {
          // æš‚åœçŠ¶æ€ â†’ æ’­æ”¾
          audio.play();
          audioState.isPlaying = true;
          console.log('ğŸµ æ’­æ”¾éŸ³ä¹ï¼Œå›¾æ ‡åˆ‡æ¢ä¸ºmusic1.pngï¼Œè¿›åº¦ï¼š', audio.currentTime.toFixed(2), 'ç§’');
        } else {
          // æ’­æ”¾çŠ¶æ€ â†’ æš‚åœ
          audio.pause();
          audioState.isPlaying = false;
          console.log('ğŸµ æš‚åœéŸ³ä¹ï¼Œå›¾æ ‡åˆ‡æ¢ä¸ºmusic.pngï¼Œè¿›åº¦ï¼š', audio.currentTime.toFixed(2), 'ç§’');
        }
        
        // åŒæ­¥ä¸¤ä¸ªé¡µé¢çš„éŸ³ä¹å›¾æ ‡çŠ¶æ€
        const otherMusicIcon = musicIcon === mainMusicIcon ? resultMusicIcon : mainMusicIcon;
        if (otherMusicIcon) {
          if (this.classList.contains('music1')) {
            otherMusicIcon.classList.add('music1');
          } else {
            otherMusicIcon.classList.remove('music1');
          }
        }
        
        // ä¿å­˜æœ€æ–°çŠ¶æ€ï¼ˆä¾›åç»­è·³è½¬/è¿”å›ä½¿ç”¨ï¼‰
        audioState.currentTime = audio.currentTime;
        audioState.icon = this.classList.contains('music1') ? 'music1.png' : 'music.png';
        localStorage.setItem('audioState', JSON.stringify(audioState));
      });
    }
    
    // åˆå§‹åŒ–éŸ³ä¹å›¾æ ‡
    setupMusicIcon(mainMusicIcon);
    setupMusicIcon(resultMusicIcon);
    
    // è·å–DOMå…ƒç´ 
    const triggerSide1 = document.getElementById('triggerSide1');
    const triggerSide2 = document.getElementById('triggerSide2');
    const triggerMiddle = document.getElementById('triggerMiddle');
    const showSide = document.getElementById('showSide');
    const showMiddle = document.getElementById('showMiddle');
    const allThreads = document.querySelectorAll('.thread');
    const coverTouming = document.getElementById('coverTouming');
    const finger = document.getElementById('finger');
    const character = document.getElementById('character');
    const nextImg = document.getElementById('nextImg');
    const mainPage = document.getElementById('mainPage');
    const resultPage = document.getElementById('resultPage');
    const resultCenterImg = document.getElementById('resultCenterImg');
    const afterImg = document.getElementById('afterImg');
    const copperOverlayImg = document.getElementById('copperOverlayImg');
    const xianpaijianBeforeImg = document.getElementById('xianpaijianBeforeImg');
    const triggerAreaTransparent = document.getElementById('triggerAreaTransparent');
    const xianpaijianBigImg = document.getElementById('xianpaijianBigImg');
    const finalImg = document.getElementById('finalImg');
    const zongmaoshuaImg = document.getElementById('zongmaoshuaImg');
    const zongmaoshuaContainer = document.getElementById('zongmaoshuaContainer');
    const tongsiImg = document.getElementById('tongsiImg');
    const tongsiContainer = document.getElementById('tongsiContainer');
    const xianpaijianImg = document.getElementById('xianpaijianImg');
    const xianpaijianContainer = document.getElementById('xianpaijianContainer');
    const resultShurongImg = document.querySelector('.result-shurong-img');
    const resultNextBtn = document.getElementById('resultNextBtn');
    
    // ========== æ–°å¢ï¼šæ¢³ç»’æç¤ºå…ƒç´  ==========
    const shurongHint = document.getElementById('shurongHint');
    const shurongFinger = document.getElementById('shurongFinger');
    
    // ========== æ–°å¢ï¼šç»“æœé¡µé€æ˜å±‚å’Œæ‰‹æŒ‡å…ƒç´  ==========
    const resultCoverTouming = document.getElementById('resultCoverTouming');
    const resultFinger = document.getElementById('resultFinger');
    
    // å˜é‡åˆå§‹åŒ–
    let currentThreadType = '';
    let isTopHidden = false;
    const zongmaoshuaOriginalTransform = zongmaoshuaContainer.style.transform || getComputedStyle(zongmaoshuaContainer).transform;
    const tongsiOriginalTransform = tongsiContainer.style.transform || getComputedStyle(tongsiContainer).transform;
    const xianpaijianOriginalTransform = xianpaijianContainer.style.transform || getComputedStyle(xianpaijianContainer).transform;
    
    // å›¾ç‰‡æ˜ å°„
    const imgMap = {
      "rh5/pink-purple-pink-before.png": "rh5/pink-purple-pink-after.png",
      "rh5/yellow-purple-yellow-before.png": "rh5/yellow-purple-yellow-after.png",
      "rh5/purple-yellow-purple-before.png": "rh5/purple-yellow-purple-after.png",
      "rh5/pink-yellow-pink-before.png": "rh5/pink-yellow-pink-after.png",
      "rh5/yellow-pink-yellow-before.png": "rh5/yellow-pink-yellow-after.png",
      "rh5/purple-pink-purple-before.png": "rh5/purple-pink-purple-after.png"
    };
    
    // ç¬¬ä¸€ç±»å›¾ç‰‡æ˜ å°„
    function getImageNameFromPath(path) {
        const parts = path.split('/');
        return parts[parts.length - 1];
    }
    
    const beforeFileNameMap = {
        "pink-purple-pink-after.png": "p-pu-p-before.png",
        "pink-yellow-pink-after.png": "p-y-p-before.png",
        "yellow-pink-yellow-after.png": "y-p-y-before.png",
        "yellow-purple-yellow-after.png": "y-pu-y-before.png",
        "purple-yellow-purple-after.png": "pu-y-pu-before.png",
        "purple-pink-purple-after.png": "pu-p-pu-before.png"
    };
    
    const finalFileNameMap = {
        "pink-purple-pink-after.png": "p-pu-p-after.png",
        "pink-yellow-pink-after.png": "p-y-p-after.png",
        "yellow-pink-yellow-after.png": "y-p-y-after.png",
        "yellow-purple-yellow-after.png": "y-pu-y-after.png",
        "purple-yellow-purple-after.png": "pu-y-pu-after.png",
        "purple-pink-purple-after.png": "pu-p-pu-after.png"
    };
    
    // å¸¸é‡è·¯å¾„
    const COPPER_OVERLAY_IMG_PATH = "rh5/tongsifugai.png";
    const GOUTIAO_IMG_PATH = "rh5/goutiao.png";
    const JIANRONG_IMG_PATH = "rh5/jianrong.png";
    const XIANPAIJIAN_BIG_IMG_PATH = "xianpaijian-big.png";
    
    // çŠ¶æ€å˜é‡
    let isFadeOutComplete = false;
    let isCopperOverlaid = false;
    let isShurongReplaced = false;
    let isXianpaijianBeforeShown = false;
    let swipeCount = 0;
    let fadeStarted = false;
    let currentOpacity = 1;
    
    // å¤§çº¿æ’å‰ªæ»‘åŠ¨ç›¸å…³
    let isXianpaijianBigActive = false;
    let isDraggingXianpaijianBig = false;
    let xianpaijianBigStartY = 0;
    let currentXianpaijianBigY = 0;
    let slideCount = 0;
    const requiredSlides = 30;
    
    // æ­¥éª¤æ§åˆ¶
    let currentStep = 0; // 0:æ¢³ç»’å‰, 1:æ¢³ç»’å®Œæˆ(å¯ç‚¹å‡»ä¸‹ä¸€æ­¥), 2:é“œä¸å‰, 3:é“œä¸å®Œæˆ(å¯ç‚¹å‡»ä¸‹ä¸€æ­¥), 4:å‰ªåˆ€å‰
    
    // ç»“æœé¡µé€æ˜å±‚æ˜¯å¦å·²éšè—
    let isResultCoverHidden = false;
    
    const canvasState = {
      side: {
        color: '',
        active: false
      },
      middle: {
        color: '',
        active: false
      }
    };

    const colorToImageMap = {
      "pink-purple": "rh5/purple-pink-purple-before.png",
      "pink-yellow": "rh5/yellow-pink-yellow-before.png",
      "purple-yellow": "rh5/yellow-purple-yellow-before.png",
      "purple-pink": "rh5/pink-purple-pink-before.png",
      "yellow-pink": "rh5/pink-yellow-pink-before.png",
      "yellow-purple": "rh5/purple-yellow-purple-before.png"
    };

    // ========== åŠŸèƒ½å‡½æ•° ==========
    
    // æ£€æŸ¥é¢œè‰²æ˜¯å¦é‡å¤
    function isColorDuplicate(targetColor) {
      return canvasState.side.color === targetColor || canvasState.middle.color === targetColor;
    }

    // éšè—ä¸»é¡µé¢é€æ˜å±‚
    function hideTopElements() {
      if (isTopHidden) return;
      
      // è·å–zi2å›¾ç‰‡å…ƒç´ 
      const zi2Image = document.getElementById('zi2Image');
      
      // å…ˆæ·¡å‡ºzi2å›¾ç‰‡
      if (zi2Image) {
        zi2Image.style.opacity = '0';
      }
      
      // ç­‰å¾…æ·¡å‡ºåŠ¨ç”»å®Œæˆåå†éšè—æ‰€æœ‰å…ƒç´ 
      setTimeout(() => {
        coverTouming.classList.add('hidden-all');
        finger.classList.add('hidden-all');
        character.classList.add('hidden-all');
        
        // åŒæ—¶éšè—zi2å›¾ç‰‡
        if (zi2Image) {
          zi2Image.classList.add('hidden-all');
        }
        
        isTopHidden = true;
        console.log('âœ… ä¸Šå±‚å…ƒç´ å·²éšè—ï¼Œæ¢å¤æ‰€æœ‰æ‹–æ‹½åŠŸèƒ½');
        
      }, 300); // ä¸CSSè¿‡æ¸¡æ—¶é—´ä¸€è‡´
    }
    
   // ========== æ˜¾ç¤ºç»“æœé¡µé€æ˜å±‚ - ä¼˜åŒ–ç‰ˆæœ¬ ==========
   function showResultCover() {
     console.log('ğŸ”¼ è°ƒç”¨ showResultCover()');
     
     // ç¡®ä¿resultCoverToumingå®Œå…¨æ˜¾ç¤º
     resultCoverTouming.style.display = 'block';
     resultCoverTouming.style.visibility = 'visible';
     resultCoverTouming.style.opacity = '1';
     
     // æ˜¾ç¤ºæ‰‹æŒ‡åŠ¨ç”» - ä½¿ç”¨ä¸¤ç‚¹æ¥å›ç§»åŠ¨åŠ¨ç”»
     resultFinger.style.display = 'block';
     resultFinger.style.opacity = '1';
     
     // è®¾ç½®åŠ¨ç”»å±æ€§ - ä½¿ç”¨ä¸¤ç‚¹ç§»åŠ¨åŠ¨ç”»
     resultFinger.style.animation = 'brushToCenterTwoPoints 2s ease-in-out infinite';
     
     // æ˜¾ç¤ºzi2å›¾ç‰‡
     const zi2Image = document.getElementById('zi2Image');
     if (zi2Image) {
       console.log('ğŸ“· æ‰¾åˆ°zi2å›¾ç‰‡å…ƒç´ ');
       
       // å…ˆé‡ç½®æ‰€æœ‰å¯èƒ½éšè—çš„æ ·å¼
       zi2Image.style.cssText = `
         display: block !important;
         visibility: visible !important;
         opacity: 1 !important;
         z-index: 2002 !important;
         position: absolute !important;
         top: 20% !important;  /* å‘ä¸Šç§»åŠ¨ä¸€äº› */
         left: 50% !important;
         transform: translate(-50%, -50%) !important;
         width: 300px !important;
         height: auto !important;
         pointer-events: none !important;
       `;
       
       // ç¡®ä¿å›¾ç‰‡æºæ­£ç¡®åŠ è½½
       const currentSrc = zi2Image.src;
       const correctSrc = "./zi2.png";
       
       if (!currentSrc || currentSrc.includes('undefined') || !zi2Image.complete) {
         console.log('ğŸ”„ è®¾ç½®/é‡ç½®zi2å›¾ç‰‡æº:', correctSrc);
         zi2Image.src = correctSrc;
       }
       
       // å›¾ç‰‡åŠ è½½å¤±è´¥å¤„ç†
       zi2Image.onerror = function() {
         console.error('âŒ zi2.pngå›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ');
         zi2Image.style.backgroundColor = 'red';
         zi2Image.style.border = '3px solid yellow';
         zi2Image.style.color = 'white';
         zi2Image.style.textAlign = 'center';
         zi2Image.style.lineHeight = '150px';
         zi2Image.innerHTML = 'zi2æç¤ºæ–‡å­—';
       };
       
       zi2Image.onload = function() {
         console.log('âœ… zi2.pngå›¾ç‰‡åŠ è½½æˆåŠŸ');
       };
     } else {
       console.error('âŒ æœªæ‰¾åˆ°zi2Imageå…ƒç´ ï¼Œæ£€æŸ¥HTMLç»“æ„ï¼');
       
       // å°è¯•åˆ›å»ºå¹¶æ·»åŠ 
       const newImg = document.createElement('img');
       newImg.id = 'zi2Image';
       newImg.className = 'zi2-image';
       newImg.src = "./zi2.png";
       newImg.alt = "æç¤ºæ–‡å­—2";
       newImg.style.cssText = `
         position: absolute;
         top: 40%;
         left: 50%;
         transform: translate(-50%, -50%);
         width: 300px;
         height: auto;
         display: block;
         opacity: 1;
         visibility: visible;
         z-index: 2002;
       `;
       resultCoverTouming.appendChild(newImg);
       console.log('âœ¨ å·²åˆ›å»ºå¹¶æ·»åŠ zi2Imageå…ƒç´ ');
     }
     
     isResultCoverHidden = false;
     console.log('âœ¨ ç»“æœé¡µé€æ˜å±‚æ˜¾ç¤ºå®Œæˆï¼Œæ‰‹æŒ‡åŠ¨ç”»å·²å¯åŠ¨ï¼ˆä¸¤ç‚¹æ¥å›ç§»åŠ¨ï¼‰');
   }
   
  // ========== éšè—ç»“æœé¡µé€æ˜å±‚ - ä¼˜åŒ–ç‰ˆæœ¬ ==========
  function hideResultCover() {
      if (isResultCoverHidden) return;
      
      console.log('ğŸ”½ è°ƒç”¨ hideResultCover()');
      
      // åœæ­¢æ‰‹æŒ‡åŠ¨ç”»
      resultFinger.style.animation = 'none';
      resultFinger.style.display = 'none';
      
      // è·å–zi2å›¾ç‰‡å…ƒç´ 
      const zi2Image = document.getElementById('zi2Image');
      
      // å…ˆæ·»åŠ æ·¡å‡ºæ•ˆæœ
      resultCoverTouming.style.transition = 'opacity 0.3s ease';
      resultCoverTouming.style.opacity = '0';
      
      if (zi2Image) {
          zi2Image.style.transition = 'opacity 0.3s ease';
          zi2Image.style.opacity = '0';
      }
      
      // ç­‰å¾…æ·¡å‡ºåŠ¨ç”»å®Œæˆåæ·»åŠ éšè—ç±»
      setTimeout(() => {
          // ä½¿ç”¨CSSç±»æ¥å®Œå…¨éšè—
          resultCoverTouming.classList.add('hidden-all');
          
          if (zi2Image) {
              zi2Image.classList.add('hidden-all');
          }
          
          isResultCoverHidden = true;
          console.log('âœ… ç»“æœé¡µé€æ˜å±‚å·²éšè—ï¼ˆå¸¦æ·¡å‡ºæ•ˆæœï¼‰');
      }, 100);
  }
  
    function showShurongHint() {
      console.log('âœ¨ æ˜¾ç¤ºæ¢³ç»’æç¤ºå’Œæ‰‹æŒ‡åŠ¨ç”»');
      
      // æ˜¾ç¤ºé€æ˜æç¤ºå›¾ç‰‡
      setTimeout(() => {
        shurongHint.classList.add('active');
        console.log('ğŸ–¼ï¸ æ¢³ç»’æç¤ºå›¾ç‰‡å·²æ˜¾ç¤º');
      }, 300);
      
      // æ˜¾ç¤ºæ‰‹æŒ‡åŠ¨ç”»
      setTimeout(() => {
        shurongFinger.classList.add('active');
        console.log('ğŸ‘† æ¢³ç»’æ‰‹æŒ‡åŠ¨ç”»å·²æ˜¾ç¤º');
      }, 600);
    }

    // éšè—æ¢³ç»’æç¤º
    function hideShurongHint() {
      shurongHint.classList.remove('active');
      shurongFinger.classList.remove('active');
      console.log('ğŸ™ˆ æ¢³ç»’æç¤ºå’Œæ‰‹æŒ‡åŠ¨ç”»å·²éšè—');
    }

    // ========== äº‹ä»¶ç›‘å¬ ==========
    
    // ç‚¹å‡»ä¸»é¡µé¢é€æ˜è¦†ç›–å±‚
    coverTouming.addEventListener('click', hideTopElements);
    
    // ç‚¹å‡»ç»“æœé¡µé€æ˜è¦†ç›–å±‚
    resultCoverTouming.addEventListener('click', hideResultCover);
    
    // æ‹–æ‹½çº¿å›¢æ—¶éšè—ä¸»é¡µé¢é€æ˜å±‚
    allThreads.forEach(thread => {
      thread.addEventListener('dragstart', hideTopElements);
    });
    
    // æ‹–æ‹½å·¥å…·æ—¶éšè—ç»“æœé¡µé€æ˜å±‚
    [zongmaoshuaImg, tongsiImg, xianpaijianImg].forEach(tool => {
      tool.addEventListener('dragstart', hideResultCover);
    });

    // é˜²æŠ–å‡½æ•°
    let isUpdating = false;
    const debounce = (fn, delay = 100) => {
      let timer;
      return (...args) => {
        if (isUpdating) return;
        clearTimeout(timer);
        timer = setTimeout(() => {
          isUpdating = true;
          fn(...args);
          isUpdating = false;
        }, delay);
      };
    };

    // æ›´æ–°ä¾§è¾¹ç”»å¸ƒ
    function updateSideCanvas(color) {
      if (isColorDuplicate(color)) {
        console.log(`âŒ ç¦æ­¢é‡å¤ï¼šä¾§è¾¹æ— æ³•è®¾ç½®å·²å­˜åœ¨çš„${color}é¢œè‰²`);
        return;
      }
      showSide.classList.remove(`side-yellow`, `side-pink`, `side-purple`);
      showSide.classList.add(`side-${color}`, 'show-active');
      canvasState.side.color = color;
      canvasState.side.active = true;
      console.log(`âœ… æ›´æ–°ä¾§è¾¹é¢œè‰²ä¸ºï¼š${color}`);
    }

    // æ›´æ–°ä¸­é—´ç”»å¸ƒ
    function updateMiddleCanvas(color) {
      if (isColorDuplicate(color)) {
        console.log(`âŒ ç¦æ­¢é‡å¤ï¼šä¸­é—´æ— æ³•è®¾ç½®å·²å­˜åœ¨çš„${color}é¢œè‰²`);
        return;
      }
      showMiddle.classList.remove(`middle-yellow`, `middle-pink`, `middle-purple`);
      showMiddle.classList.add(`middle-${color}`, 'show-active');
      canvasState.middle.color = color;
      canvasState.middle.active = true;
      console.log(`âœ… æ›´æ–°ä¸­é—´é¢œè‰²ä¸ºï¼š${color}`);
    }

    const debounceUpdateSide = debounce(updateSideCanvas);
    const debounceUpdateMiddle = debounce(updateMiddleCanvas);

    // çº¿å›¢æ‹–æ‹½äº‹ä»¶
    allThreads.forEach(thread => {
      thread.addEventListener('dragstart', (e) => {
        currentThreadType = e.target.dataset.type;
        e.dataTransfer.setData('text', currentThreadType);
        console.log(`ğŸ‘‰ å¼€å§‹æ‹–æ‹½ï¼š${currentThreadType}çº¿å›¢`);
      });
    });

    // å…è®¸æ”¾ç½®
    function allowDrop(e) {
      e.preventDefault();
      e.stopPropagation();
    }
    
    triggerSide1.addEventListener('dragover', allowDrop);
    triggerSide2.addEventListener('dragover', allowDrop);
    triggerMiddle.addEventListener('dragover', allowDrop);

    // ä¾§è¾¹åŒºåŸŸæ”¾ç½®
    triggerSide1.addEventListener('drop', (e) => {
      e.preventDefault();
      e.stopPropagation();
      if (currentThreadType) debounceUpdateSide(currentThreadType);
    });

    triggerSide2.addEventListener('drop', (e) => {
      e.preventDefault();
      e.stopPropagation();
      if (currentThreadType) debounceUpdateSide(currentThreadType);
    });

    // ä¸­é—´åŒºåŸŸæ”¾ç½®
    triggerMiddle.addEventListener('drop', (e) => {
      e.preventDefault();
      e.stopPropagation();
      if (currentThreadType) debounceUpdateMiddle(currentThreadType);
    });

    // å…¨å±€æ‹–æ‹½äº‹ä»¶
    document.addEventListener('drop', (e) => {
      e.preventDefault();
    });
    document.addEventListener('dragover', (e) => {
      e.preventDefault();
    });
    document.addEventListener('dragend', () => {
      currentThreadType = '';
    });

    // ==================== ä¿®å¤ï¼šåˆ‡æ¢åˆ°ç»“æœé¡µçš„æ­£ç¡®ç‰ˆæœ¬ ====================
    // ä¿®å¤ç»“æœé¡µåŠŸèƒ½ä¸å¯ç”¨çš„é—®é¢˜
    
    // åˆ‡æ¢åˆ°ç»“æœé¡µ - ä¿®å¤ç‰ˆæœ¬
    function switchToResultPage() {
      const sideColor = canvasState.side.color;
      const middleColor = canvasState.middle.color;
      if (!sideColor || !middleColor) {
        return;
      }
    
      const key = `${middleColor}-${sideColor}`;
      const imgSrc = colorToImageMap[key] || '';
      if (imgSrc) {
        // åªé‡ç½®å¿…è¦çš„å›¾ç‰‡æºï¼Œä¸éšè—ä»»ä½•å…ƒç´ 
        resultCenterImg.src = imgSrc;
        resultCenterImg.classList.remove('fade-out');
        resultCenterImg.style.opacity = '1';
        
        // åªé‡ç½®afterå›¾ç‰‡çš„æºï¼Œä¸æ”¹å˜æ˜¾ç¤ºçŠ¶æ€
        afterImg.src = '';
        afterImg.classList.remove('fade-in');
        afterImg.style.opacity = '0';
        
        // åªé‡ç½®å…¶ä»–å›¾ç‰‡çš„æºï¼Œä¸æ”¹å˜æ˜¾ç¤ºçŠ¶æ€
        copperOverlayImg.src = '';
        copperOverlayImg.classList.remove('fade-in');
        copperOverlayImg.style.opacity = '0';
        
        xianpaijianBeforeImg.src = '';
        xianpaijianBeforeImg.classList.remove('fade-in');
        xianpaijianBeforeImg.style.opacity = '0';
        
        xianpaijianBigImg.src = '';
        xianpaijianBigImg.classList.remove('active', 'dragging');
        
        finalImg.src = '';
        finalImg.classList.remove('fade-in');
        finalImg.style.opacity = '0';
        
        // é‡ç½®æ¢³ç»’å›¾ç‰‡
        resultShurongImg.src = "rh5/shurong.png";
        
        // é‡ç½®çŠ¶æ€å˜é‡
        isFadeOutComplete = false;
        isCopperOverlaid = false;
        isShurongReplaced = false;
        isXianpaijianBeforeShown = false;
        isXianpaijianBigActive = false;
        isDraggingXianpaijianBig = false;
        swipeCount = 0;
        slideCount = 0;
        fadeStarted = false;
        currentOpacity = 1;
        
        // éšè—æ¢³ç»’æç¤º
        hideShurongHint();
        
        // é‡ç½®æ­¥éª¤
        currentStep = 0;
        resultNextBtn.classList.remove('active');
        console.log('ğŸ”„ è¿›å…¥ç»“æœé¡µï¼Œåˆå§‹æ­¥éª¤ï¼šæ¢³ç»’å‰');
        
        // å…ˆåˆ‡æ¢é¡µé¢
        mainPage.style.display = 'none';
        resultPage.style.display = 'block';
        window.scrollTo(0, 0);
        
        // ç¡®ä¿ç»“æœé¡µçš„æ‰€æœ‰å…ƒç´ éƒ½æ˜¯å¯è§å’Œå¯äº¤äº’çš„
        setTimeout(() => {
          console.log('â° é¡µé¢åˆ‡æ¢å®Œæˆï¼Œåˆå§‹åŒ–ç»“æœé¡µåŠŸèƒ½');
          
          // ç¡®ä¿æ‰€æœ‰å·¥å…·å…ƒç´ å¯è§å¯äº¤äº’
          [zongmaoshuaImg, tongsiImg, xianpaijianImg].forEach(tool => {
            tool.style.display = 'block';
            tool.style.visibility = 'visible';
            tool.style.opacity = '1';
            tool.style.pointerEvents = 'auto';
          });
          
          // ç¡®ä¿ä¸­å¿ƒå›¾ç‰‡å¯è§
          resultCenterImg.style.display = 'block';
          resultCenterImg.style.visibility = 'visible';
          
          // ç¡®ä¿ç»“æœé¡µæŒ‰é’®å¯è§
          resultNextBtn.style.display = 'block';
          resultNextBtn.style.visibility = 'visible';
          
          // ç¡®ä¿é€æ˜åŒºåŸŸå¯è§
          triggerAreaTransparent.style.display = 'none'; // åˆå§‹éšè—
          
          // ç¡®ä¿å¤§çº¿æ’å‰ªåˆå§‹éšè—
          xianpaijianBigImg.style.display = 'none';
          
          // ç¡®ä¿æœ€ç»ˆå›¾ç‰‡åˆå§‹éšè—
          finalImg.style.display = 'none';
          
          // æ˜¾ç¤ºé€æ˜å±‚ï¼ˆå¼•å¯¼ç”¨æˆ·ç‚¹å‡»ï¼‰
          showResultCover();
          
          console.log('âœ… ç»“æœé¡µæ‰€æœ‰åŠŸèƒ½å…ƒç´ å·²æ­£ç¡®åˆå§‹åŒ–');
        }, 50);
        
      } else {
        alert('æš‚æ— å¯¹åº”çš„æ­é…å›¾ç‰‡ï¼');
        mainPage.style.display = 'none';
        resultPage.style.display = 'block';
        window.scrollTo(0, 0);
      }
    }
    
    // ä¸‹ä¸€æ­¥æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    nextImg.addEventListener('click', switchToResultPage);

    // ========== æ¢³ç»’æ­¥éª¤é€»è¾‘ ==========
    
    // æ£•æ¯›åˆ·æ‹–æ‹½å¼€å§‹
    zongmaoshuaImg.addEventListener('dragstart', (e) => {
      if (currentStep > 0) {
        e.preventDefault();
        console.log('âŒ æ¢³ç»’å·²å®Œæˆï¼Œè¯·ç‚¹å‡»ä¸‹ä¸€æ­¥');
        return;
      }
      
      // éšè—æ¢³ç»’æç¤º
      hideShurongHint();
      
      e.dataTransfer.setData('text/plain', 'zongmaoshua');
      e.dataTransfer.effectAllowed = 'move';
      console.log('ğŸ‘‰ å¼€å§‹æ‹–æ‹½æ£•æ¯›åˆ·');
    });
    
    const centerImgWrapper = document.querySelector('.center-img-wrapper');
    
    // è¿›å…¥ç»’å¸ƒåŒºåŸŸ
    centerImgWrapper.addEventListener('dragenter', (e) => {
      e.preventDefault();
      if (!resultCenterImg.src) return;
      console.log('ğŸ–Œï¸ æ£•æ¯›åˆ·è¿›å…¥ç»’å¸ƒåŒºåŸŸ');
    });
    
    // æ»‘åŠ¨æ£€æµ‹
    let lastY = 0;
    centerImgWrapper.addEventListener('dragover', (e) => {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      
      if (!resultCenterImg.src || fadeStarted) return;
      
      const currentY = e.clientY;
      
      if (lastY !== 0 && Math.abs(currentY - lastY) > 30) {
        swipeCount++;
        console.log(`â†•ï¸ æ»‘åŠ¨æ£€æµ‹åˆ°ç¬¬ ${swipeCount} æ¬¡æ»‘åŠ¨`);
        
        if (swipeCount >= 1 && !fadeStarted) {
          startFadeOut();
        }
        
        lastY = currentY;
      }
      
      if (lastY === 0) {
        lastY = currentY;
      }
    });
    
    // å¼€å§‹æ·¡å‡ºæ•ˆæœ
    function startFadeOut() {
      if (fadeStarted) return;
      
      fadeStarted = true;
      
      const currentCenterSrc = resultCenterImg.src.split('/').pop() ? 
        `rh5/${resultCenterImg.src.split('/').pop()}` : resultCenterImg.src;
      const afterSrc = imgMap[currentCenterSrc];
      if (!afterSrc) return;
      
      afterImg.src = afterSrc;
      afterImg.style.display = 'block';
      
      console.log('âœ¨ å¼€å§‹ç¼“æ…¢æ·¡å‡ºæ•ˆæœ'); 
      
      currentOpacity = 1;
      const fadeInterval = setInterval(() => {
        currentOpacity -= 0.1;
        
        if (currentOpacity <= 0) {
          clearInterval(fadeInterval);
          currentOpacity = 0;
          
          resultCenterImg.classList.add('fade-out');
          afterImg.classList.add('fade-in');
          
          isFadeOutComplete = true;
          
          if (!isShurongReplaced) {
            resultShurongImg.src = GOUTIAO_IMG_PATH;
            isShurongReplaced = true;
            console.log('ğŸ”„ æ¢³ç»’å›¾ç‰‡å·²æ›¿æ¢ä¸º goutiao.png');
          }
          
          // æ¢³ç»’å®Œæˆï¼Œæ˜¾ç¤ºä¸‹ä¸€æ­¥æŒ‰é’®
          currentStep = 1;
          resultNextBtn.classList.add('active');
          console.log('âœ… æ¢³ç»’å®Œæˆï¼Œä¸‹ä¸€æ­¥æŒ‰é’®å·²æ¿€æ´»');
          
          setTimeout(() => {
            zongmaoshuaContainer.style.transform = zongmaoshuaOriginalTransform;
            console.log('âœ… æ·¡å‡ºæ•ˆæœå®Œæˆï¼Œæ£•æ¯›åˆ·å·²å½’ä½');
          }, 500);
        } else {
          resultCenterImg.style.opacity = currentOpacity;
          afterImg.style.opacity = 1 - currentOpacity;
        }
      }, 200);
    }
    
    // ç¦»å¼€ç»’å¸ƒåŒºåŸŸ
    centerImgWrapper.addEventListener('dragleave', (e) => {
      e.preventDefault();
      lastY = 0;
    });
    
    // æ”¾ç½®æ£•æ¯›åˆ·
    centerImgWrapper.addEventListener('drop', (e) => {
      e.preventDefault();
      
      if (!resultCenterImg.src) return;
      
      if (!fadeStarted && swipeCount >= 3) {
        startFadeOut();
      }
      
      lastY = 0;
    });
    
    // æ‹–æ‹½ç»“æŸ
    document.addEventListener('dragend', (e) => {
      lastY = 0;
      
      if (!fadeStarted || (fadeStarted && currentOpacity <= 0)) {
        zongmaoshuaContainer.style.transform = zongmaoshuaOriginalTransform;
        console.log('â†©ï¸ æ£•æ¯›åˆ·æ‹–æ‹½ç»“æŸï¼Œå·²å½’ä½');
      }
      
      if (!fadeStarted) {
        swipeCount = 0;
      }
    });
    
    // ========== ç»“æœé¡µä¸‹ä¸€æ­¥æŒ‰é’®ç‚¹å‡»äº‹ä»¶ ==========
    resultNextBtn.addEventListener('click', function(e) {
        e.preventDefault(); // é˜²æ­¢é»˜è®¤è¡Œä¸º
        
        if (currentStep === 1) {
            // ä»æ¢³ç»’å®Œæˆåˆ°é“œä¸æ­¥éª¤
            console.log('ğŸ”„ ç‚¹å‡»ä¸‹ä¸€æ­¥ï¼šè¿›å…¥é“œä¸æ­¥éª¤');
            currentStep = 2;
            resultNextBtn.classList.remove('active');
            
        } else if (currentStep === 3) {
            // ä»é“œä¸å®Œæˆåˆ°å‰ªåˆ€æ­¥éª¤
            console.log('ğŸ”„ ç‚¹å‡»ä¸‹ä¸€æ­¥ï¼šè¿›å…¥å‰ªåˆ€æ­¥éª¤');
            currentStep = 4;
            resultNextBtn.classList.remove('active');
            
        } else if (currentStep === 99) {
            // æœ€åä¸€æ­¥ï¼šè·³è½¬åˆ°ä¸‹ä¸€ä¸ªé¡µé¢
            console.log('ğŸ‰ æ‰€æœ‰æ­¥éª¤å·²å®Œæˆï¼è·³è½¬åˆ°ä¸‹ä¸€é¡µé¢');
            
            // è·å–ç”¨æˆ·é€‰æ‹©çš„é¢œè‰²ç»„åˆ
            const sideColor = canvasState.side.color;  // è¾¹ç¼˜é¢œè‰²
            const middleColor = canvasState.middle.color; // ä¸­å¿ƒé¢œè‰²
            
            console.log(`ğŸ¨ ç”¨æˆ·é€‰æ‹©çš„é¢œè‰²ï¼šä¸­å¿ƒ=${middleColor}, è¾¹ç¼˜=${sideColor}`);
            
            // è·å–ä¸‹ä¸€é¡µé¢URL
            let nextPageUrl = this.getAttribute('data-next-url') || "/ç»’èŠ±/flower-6/index6.html";
            
            // ä¿®å¤è·¯å¾„æ ¼å¼ï¼ˆå°†åæ–œæ æ›¿æ¢ä¸ºæ­£æ–œæ ï¼‰
            nextPageUrl = nextPageUrl.replace(/\\/g, '/');
            
            // æ·»åŠ é¢œè‰²å‚æ•°åˆ°URL
            const separator = nextPageUrl.includes('?') ? '&' : '?';
            nextPageUrl = `${nextPageUrl}${separator}mid=${middleColor}&side=${sideColor}`;
            
            console.log('ğŸ” å½“å‰é¡µé¢URL:', window.location.href);
            console.log('ğŸ” ç›®æ ‡é¡µé¢URL:', nextPageUrl);
            
            // ä¿å­˜å½“å‰éŸ³ä¹çŠ¶æ€ï¼Œä»¥ä¾¿ä¸‹ä¸€é¡µç»§ç»­æ’­æ”¾
            audioState.currentTime = audio.currentTime;
            audioState.isPlaying = !audio.paused;
            audioState.icon = mainMusicIcon.classList.contains('music1') ? 'music1.png' : 'music.png';
            localStorage.setItem('audioState', JSON.stringify(audioState));
            
            // åŒæ—¶ä¿å­˜åˆ°localStorageä½œä¸ºå¤‡ç”¨
            try {
                // ä¿å­˜é¢œè‰²ä¿¡æ¯åˆ°localStorage
                localStorage.setItem('midColor', middleColor);
                localStorage.setItem('sideColor', sideColor);
                
                // ä¿å­˜å›¾ç‰‡è·¯å¾„åˆ°localStorageï¼ˆå¦‚æœè¿˜éœ€è¦ï¼‰
                if (afterImg.src) {
                    const fileName = getImageNameFromPath(afterImg.src);
                    const savedImagePath = `rh5/${fileName}`;
                    localStorage.setItem('previousFlowerImage', savedImagePath);
                    console.log('ğŸ’¾ ä¿å­˜å›¾ç‰‡è·¯å¾„åˆ°localStorage:', savedImagePath);
                }
                
                console.log('ğŸ’¾ é¢œè‰²ä¿¡æ¯å·²ä¿å­˜åˆ°localStorage');
            } catch (e) {
                console.warn('âš ï¸ ä¿å­˜åˆ°localStorageå¤±è´¥:', e);
            }
            
            // å°è¯•è·³è½¬
            try {
                console.log('ğŸš€ è·³è½¬åˆ°ä¸‹ä¸€ä¸ªé¡µé¢');
                window.location.href = nextPageUrl;
                
            } catch (error) {
                console.error('âŒ è·³è½¬å¤±è´¥:', error);
                
                // å¤‡ç”¨æ–¹æ¡ˆï¼šå°è¯•ç›¸å¯¹è·¯å¾„è·³è½¬
                try {
                    const baseUrl = '../flower-6/index6.html';
                    const backupUrl = `${baseUrl}?mid=${middleColor}&side=${sideColor}`;
                    console.log('ğŸš€ å°è¯•å¤‡ç”¨è·¯å¾„:', backupUrl);
                    window.location.href = backupUrl;
                } catch (error2) {
                    console.error('âŒ å¤‡ç”¨è·¯å¾„ä¹Ÿå¤±è´¥:', error2);
                    alert('é¡µé¢è·³è½¬å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–è”ç³»ç®¡ç†å‘˜');
                }
            }
        }
    });
    
    // ========== é“œä¸è¦†ç›–åŠŸèƒ½ ==========
    
    // é“œä¸æ‹–æ‹½å¼€å§‹
    tongsiImg.addEventListener('dragstart', (e) => {
      if (currentStep < 2) {
        e.preventDefault();
        console.log('âŒ è¯·å…ˆå®Œæˆæ¢³ç»’å¹¶ç‚¹å‡»ä¸‹ä¸€æ­¥ï¼Œå†ä½¿ç”¨é“œä¸');
        return;
      }
      
      if (currentStep > 2) {
        e.preventDefault();
        console.log('âŒ é“œä¸å·²å®Œæˆï¼Œè¯·ç‚¹å‡»ä¸‹ä¸€æ­¥');
        return;
      }
      
      if (isCopperOverlaid) {
        e.preventDefault();
        console.log('âŒ é“œä¸å·²ç»è¦†ç›–è¿‡äº†');
        return;
      }
      
      e.dataTransfer.setData('text/plain', 'tongsi');
      e.dataTransfer.effectAllowed = 'move';
      console.log('ğŸ‘‰ å¼€å§‹æ‹–æ‹½é“œä¸');
    });
    
    // é“œä¸æ”¾ç½®
    centerImgWrapper.addEventListener('drop', (e) => {
      e.preventDefault();
      
      const toolType = e.dataTransfer.getData('text/plain');
      
      if (toolType === 'tongsi' && isFadeOutComplete && !isCopperOverlaid && currentStep === 2) {
        console.log('ğŸ”§ æ”¾ç½®é“œä¸åˆ°ç»’å¸ƒä¸Š');
        
        copperOverlayImg.src = COPPER_OVERLAY_IMG_PATH;
        copperOverlayImg.style.display = 'block';
        
        setTimeout(() => {
          copperOverlayImg.classList.add('fade-in');
          console.log('âœ¨ é“œä¸è¦†ç›–å›¾ç‰‡å¼€å§‹æ·¡å…¥');
          
          isCopperOverlaid = true;
          tongsiContainer.style.transform = tongsiOriginalTransform;
          
          // é“œä¸è¦†ç›–å®Œæˆï¼Œæ˜¾ç¤ºä¸‹ä¸€æ­¥æŒ‰é’®
          currentStep = 3;
          resultNextBtn.classList.add('active');
          console.log('âœ… é“œä¸è¦†ç›–å®Œæˆï¼Œä¸‹ä¸€æ­¥æŒ‰é’®å·²æ¿€æ´»');
          
        }, 100);
      }
    });
    
    // é“œä¸æ‹–æ‹½ç»“æŸ
    tongsiImg.addEventListener('dragend', (e) => {
      if (!isCopperOverlaid) {
        tongsiContainer.style.transform = tongsiOriginalTransform;
        console.log('â†©ï¸ é“œä¸æ‹–æ‹½ç»“æŸï¼Œå·²å½’ä½');
      }
    });
    
    // ========== çº¿æ’å‰ªæ‹–æ‹½åŠŸèƒ½ï¼ˆç¬¬ä¸€æ¬¡æ‹–åŠ¨ï¼‰==========
    
    // çº¿æ’å‰ªæ‹–æ‹½å¼€å§‹ï¼ˆç¬¬ä¸€æ¬¡ï¼‰
    xianpaijianImg.addEventListener('dragstart', (e) => {
      if (currentStep < 4) {
        e.preventDefault();
        console.log('âŒ è¯·å…ˆå®Œæˆé“œä¸å¹¶ç‚¹å‡»ä¸‹ä¸€æ­¥ï¼Œå†ä½¿ç”¨çº¿æ’å‰ª');
        return;
      }
      
      e.dataTransfer.setData('text/plain', 'xianpaijian');
      e.dataTransfer.effectAllowed = 'move';
      console.log('âœ‚ï¸ å¼€å§‹ç¬¬ä¸€æ¬¡æ‹–æ‹½çº¿æ’å‰ª');
    });
    
    // çº¿æ’å‰ªæ‹–æ‹½ç»“æŸ
    xianpaijianImg.addEventListener('dragend', (e) => {
        console.log('âœ‚ï¸ çº¿æ’å‰ªæ‹–æ‹½ç»“æŸ');
        
        if (currentStep < 4) return;
        
        if (!isXianpaijianBeforeShown) {
            // ç¬¬ä¸€æ¬¡æ‹–æ‹½ï¼Œæ˜¾ç¤ºç¬¬ä¸€ç±»å›¾ç‰‡
            console.log('ğŸ¯ ç¬¬ä¸€æ¬¡æ‹–æ‹½çº¿æ’å‰ªå®Œæˆï¼Œæ˜¾ç¤ºç¬¬ä¸€ç±»å›¾ç‰‡');
            showBeforeImage();
        } else if (isXianpaijianBeforeShown && !isXianpaijianBigActive) {
            // ç¬¬äºŒæ¬¡æ‹–æ‹½åˆ°é€æ˜åŒºåŸŸï¼Œæ˜¾ç¤ºå¤§çº¿æ’å‰ª
            console.log('ğŸ¯ ç¬¬äºŒæ¬¡æ‹–æ‹½çº¿æ’å‰ªåˆ°é€æ˜åŒºåŸŸ');
            showXianpaijianBig();
        }
        
        // çº¿æ’å‰ªå½’ä½
        setTimeout(() => {
            xianpaijianContainer.style.cssText = `
                position: relative;
                display: inline-flex;
                flex-direction: column;
                align-items: center;
                z-index: 30;
                transform-origin: bottom center;
                transform: rotate(0deg) translate(15px, -8px) !important;
                margin-left: 5%;
                --rotate: 0deg;
            `;
            
            console.log('â†©ï¸ çº¿æ’å‰ªå·²å¼ºåˆ¶å½’ä½ï¼Œå¯ä»¥å†æ¬¡æ‹–åŠ¨');
        }, 50);
    });
    
    // æ˜¾ç¤ºç¬¬ä¸€ç±»å›¾ç‰‡
    function showBeforeImage() {
      console.log('ğŸ”„ å¼€å§‹æ˜¾ç¤ºç¬¬ä¸€ç±»å›¾ç‰‡...');
      
      isXianpaijianBeforeShown = true;
      
      // 1. å°†goutiaoæ›¿æ¢æˆjianrong.png
      if (resultShurongImg.src.includes('goutiao')) {
        resultShurongImg.src = JIANRONG_IMG_PATH;
        console.log('âœ… goutiaoå·²æ›¿æ¢ä¸º jianrong.png');
      }
      
      // 2. éšè—é“œä¸è¦†ç›–å›¾ç‰‡
      if (copperOverlayImg.src) {
        copperOverlayImg.style.display = 'none';
        copperOverlayImg.classList.remove('fade-in');
        copperOverlayImg.style.opacity = '0';
        console.log('âœ… tongsifugai.pngå·²éšè—');
      }
      
      // 3. éšè—afterå›¾ç‰‡
      if (afterImg.src) {
        afterImg.style.display = 'none';
        afterImg.classList.remove('fade-in');
        afterImg.style.opacity = '0';
        console.log('âœ… afterå›¾ç‰‡å·²éšè—');
      }
      
      // 4. æ ¹æ®å½“å‰afterå›¾ç‰‡æ˜¾ç¤ºå¯¹åº”çš„ç¬¬ä¸€ç±»å›¾ç‰‡
      if (afterImg.src) {
        const currentAfterPath = afterImg.src;
        console.log(`ğŸ“· å½“å‰afterå›¾ç‰‡è·¯å¾„: ${currentAfterPath}`);
        
        const fileName = getImageNameFromPath(currentAfterPath);
        console.log(`ğŸ“ æå–çš„æ–‡ä»¶å: ${fileName}`);
        
        const beforeFileName = beforeFileNameMap[fileName];
        
        if (beforeFileName) {
          const beforeImgPath = "rh5/" + beforeFileName;
          console.log(`ğŸ¨ æ ¹æ®æ–‡ä»¶åæ˜¾ç¤ºç¬¬ä¸€ç±»å›¾ç‰‡: ${beforeImgPath}`);
          
          xianpaijianBeforeImg.src = beforeImgPath;
          xianpaijianBeforeImg.style.display = 'block';
          
          setTimeout(() => {
            xianpaijianBeforeImg.classList.add('fade-in');
            console.log('âœ¨ ç¬¬ä¸€ç±»å›¾ç‰‡å¼€å§‹æ·¡å…¥');
            
            // æ˜¾ç¤ºé€æ˜è§¦å‘åŒºåŸŸ
            triggerAreaTransparent.style.display = 'block';
            console.log('ğŸ¯ é€æ˜è§¦å‘åŒºåŸŸå·²æ˜¾ç¤º');
            console.log('ğŸ”§ å¯ä»¥å†æ¬¡æ‹–æ‹½çº¿æ’å‰ªåˆ°é€æ˜åŒºåŸŸ');
          }, 300);
          
          console.log(`âœ… å·²æ˜¾ç¤ºç¬¬ä¸€ç±»å›¾ç‰‡: ${beforeImgPath}`);
        } else {
          console.log(`âŒ æœªæ‰¾åˆ°å¯¹åº”çš„ç¬¬ä¸€ç±»å›¾ç‰‡ for fileName: ${fileName}`);
        }
      } else {
        console.log('âŒ æœªæ£€æµ‹åˆ°afterå›¾ç‰‡ï¼Œæ— æ³•ç¡®å®šç¬¬ä¸€ç±»å›¾ç‰‡');
      }
      
      console.log('ğŸ‰ ç¬¬ä¸€ç±»å›¾ç‰‡æ˜¾ç¤ºå®Œæˆï¼å¯ä»¥å†æ¬¡æ‹–æ‹½çº¿æ’å‰ªåˆ°é€æ˜åŒºåŸŸ');
    }
    
    // æ˜¾ç¤ºå¤§çº¿æ’å‰ª
    function showXianpaijianBig() {
       console.log('ğŸ”§ æ˜¾ç¤ºå¤§çº¿æ’å‰ª');
       
       xianpaijianBigImg.src = XIANPAIJIAN_BIG_IMG_PATH;
       xianpaijianBigImg.classList.add('active');
       xianpaijianBigImg.style.display = 'block';
       
       // åˆå§‹åŒ–ä½ç½®
       xianpaijianBigImg.style.top = '300px';
       xianpaijianBigImg.style.left = '55%';
       xianpaijianBigImg.style.transform = 'translateX(0)';
       
       isXianpaijianBigActive = true;
       slideCount = 0;
       
       console.log('ğŸ”§ å¤§çº¿æ’å‰ªå·²æ˜¾ç¤ºï¼Œå¯ä»¥åœ¨é€æ˜åŒºåŸŸå†…ä¸Šä¸‹æ»‘åŠ¨');
    }
    
    // ========== å¤§çº¿æ’å‰ªæ»‘åŠ¨åŠŸèƒ½ ==========
    
    // å¤§çº¿æ’å‰ªé¼ æ ‡äº‹ä»¶
    xianpaijianBigImg.addEventListener('mousedown', startDragXianpaijianBig);
    document.addEventListener('mousemove', dragXianpaijianBig);
    document.addEventListener('mouseup', stopDragXianpaijianBig);
    
    function startDragXianpaijianBig(e) {
        if (!isXianpaijianBigActive) return;
        
        e.preventDefault();
        isDraggingXianpaijianBig = true;
        xianpaijianBigImg.classList.add('dragging');
        xianpaijianBigStartY = e.clientY;
        currentXianpaijianBigY = e.clientY;
        
        console.log('ğŸ–±ï¸ å¼€å§‹æ‹–åŠ¨å¤§çº¿æ’å‰ª');
    }
    
    function dragXianpaijianBig(e) {
        if (!isDraggingXianpaijianBig || !isXianpaijianBigActive) return;
        
        e.preventDefault();
        currentXianpaijianBigY = e.clientY;
        
        const triggerRect = triggerAreaTransparent.getBoundingClientRect();
        
        if (Math.abs(currentXianpaijianBigY - xianpaijianBigStartY) > 50) {
            slideCount++;
            console.log(`â†•ï¸ å¤§çº¿æ’å‰ªæ»‘åŠ¨æ£€æµ‹åˆ°ç¬¬ ${slideCount} æ¬¡æ»‘åŠ¨`);
            
            xianpaijianBigStartY = currentXianpaijianBigY;
            
            if (slideCount >= requiredSlides) {
                showFinalImage();
            }
        }
        
        const deltaY = currentXianpaijianBigY - triggerRect.top - 50;
        xianpaijianBigImg.style.transform = `translateX(-50%) translateY(${deltaY}px)`;
    }
    
    function stopDragXianpaijianBig() {
        if (!isDraggingXianpaijianBig) return;
        
        isDraggingXianpaijianBig = false;
        xianpaijianBigImg.classList.remove('dragging');
        xianpaijianBigImg.style.transform = 'translateX(-50%)';
        
        console.log('ğŸ›‘ åœæ­¢æ‹–åŠ¨å¤§çº¿æ’å‰ª');
    }
    
    // æ˜¾ç¤ºæœ€ç»ˆå›¾ç‰‡ - ä¿®æ”¹ç‰ˆæœ¬
    function showFinalImage() {
       if (!afterImg.src) {
           console.log('âŒ æœªæ‰¾åˆ°afterå›¾ç‰‡ï¼Œæ— æ³•æ˜¾ç¤ºæœ€ç»ˆå›¾ç‰‡');
           return;
       }
       
       const currentAfterPath = afterImg.src;
       console.log(`ğŸ“· å½“å‰afterå›¾ç‰‡è·¯å¾„: ${currentAfterPath}`);
       
       const fileName = getImageNameFromPath(currentAfterPath);
       console.log(`ğŸ“ æå–çš„æ–‡ä»¶å: ${fileName}`);
       
       const finalFileName = finalFileNameMap[fileName];
       
       if (finalFileName) {
           const finalImgPath = "rh5/" + finalFileName;
           console.log(`ğŸ¨ æ ¹æ®æ–‡ä»¶åæ˜¾ç¤ºæœ€ç»ˆå›¾ç‰‡: ${finalImgPath}`);
           
           finalImg.src = finalImgPath;
           finalImg.style.display = 'block';
           finalImg.style.opacity = '0';
           
           // éšè—å¤§çº¿æ’å‰ª
           xianpaijianBigImg.style.opacity = '0';
           setTimeout(() => {
               xianpaijianBigImg.classList.remove('active');
               xianpaijianBigImg.style.display = 'none';
           }, 300);
           
           // éšè—é€æ˜åŒºåŸŸ
           triggerAreaTransparent.style.opacity = '0';
           setTimeout(() => {
               triggerAreaTransparent.style.display = 'none';
           }, 300);
           
           // éšè—ç¬¬ä¸€ç±»å›¾ç‰‡
           xianpaijianBeforeImg.style.opacity = '0';
           setTimeout(() => {
               xianpaijianBeforeImg.style.display = 'none';
               xianpaijianBeforeImg.classList.remove('fade-in');
           }, 300);
           
           // æ·¡å…¥æœ€ç»ˆå›¾ç‰‡
           setTimeout(() => {
               finalImg.classList.add('fade-in');
               console.log('âœ¨ æœ€ç»ˆå›¾ç‰‡å¼€å§‹æ·¡å…¥');
               
               isXianpaijianBigActive = false;
               
               // ========== å…³é”®ä¿®æ”¹ï¼šå‰ªåˆ€å®Œæˆå ==========
               // è®¾ç½®ä¸€ä¸ªç‰¹æ®Šçš„çŠ¶æ€æ ‡å¿—
               currentStep = 99; // è®¾ç½®ä¸ºä¸€ä¸ªå®ŒæˆçŠ¶æ€ï¼Œä¸ä¸å…¶ä»–æ­¥éª¤å†²çª
               
               // æ˜¾ç¤ºä¸‹ä¸€æ­¥æŒ‰é’®ï¼Œä½†ç‚¹å‡»åä¸ä¼šéšè—
               resultNextBtn.classList.add('active');
               
               // åœ¨æŒ‰é’®ä¸Šæ·»åŠ ä¸€ä¸ªæ ‡è®°ï¼Œè¡¨ç¤ºè¿™æ˜¯æœ€åä¸€æ­¥
               resultNextBtn.setAttribute('data-last-step', 'true');
               
               console.log('âœ… å‰ªåˆ€æ­¥éª¤å®Œæˆï¼Œä¸‹ä¸€æ­¥æŒ‰é’®ä¿æŒæ˜¾ç¤ºï¼ˆç‚¹å‡»å°†è·³è½¬åˆ°ä¸‹ä¸€é¡µé¢ï¼‰');
               
           }, 500);
           
           console.log(`âœ… å·²æ˜¾ç¤ºæœ€ç»ˆå›¾ç‰‡: ${finalImgPath}`);
       } else {
           console.log(`âŒ æœªæ‰¾åˆ°å¯¹åº”çš„æœ€ç»ˆå›¾ç‰‡ for fileName: ${fileName}`);
       }
    }
    
    // é€æ˜åŒºåŸŸæ‹–æ‹½æ”¯æŒ
    triggerAreaTransparent.addEventListener('dragover', (e) => {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
    });
    
    // å·¥å…·å½’ä½é€»è¾‘
    document.querySelectorAll('.result-tool-img').forEach(toolImg => {
      if (toolImg !== zongmaoshuaImg && toolImg !== tongsiImg && toolImg !== xianpaijianImg) {
        toolImg.addEventListener('dragend', (e) => {
          e.target.parentElement.style.transform = getComputedStyle(e.target.parentElement).transform;
          console.log(`â†©ï¸ ${toolImg.alt}æ‹–æ‹½ç»“æŸï¼Œå·²å½’ä½`);
        });
      }
    });
    
    // ========== é¡µé¢åˆå§‹åŒ–ä»£ç  ==========
    window.addEventListener('load', function() {
      console.log('ğŸ“„ é¡µé¢åŠ è½½å®Œæˆ');
      console.log('ğŸµ éŸ³ä¹å›¾æ ‡å·²æ˜¾ç¤ºåœ¨èƒŒæ™¯å›¾ç‰‡å³ä¸Šè§’');
      
      const zi2Image = document.getElementById('zi2Image');
      if (zi2Image) {
        console.log('ğŸ“ zi2å›¾ç‰‡è·¯å¾„:', zi2Image.src);
        
        if (!zi2Image.src || zi2Image.src.includes(window.location.href)) {
          zi2Image.src = "./zi2.png";
          console.log('ğŸ”„ å¼ºåˆ¶è®¾ç½®zi2å›¾ç‰‡è·¯å¾„');
        }
      }
      
      function checkImageExists(url, callback) {
        var img = new Image();
        img.onload = function() { callback(true); };
        img.onerror = function() { callback(false); };
        img.src = url;
      }
      
      checkImageExists("./zi2.png", function(exists) {
        console.log(exists ? 'âœ… zi2.pngæ–‡ä»¶å­˜åœ¨' : 'âŒ zi2.pngæ–‡ä»¶ä¸å­˜åœ¨');
      });
      
      // ç¡®ä¿éŸ³ä¹å›¾æ ‡åœ¨ç»“æœé¡µä¹Ÿæ­£å¸¸æ˜¾ç¤º
      if (resultMusicIcon) {
        // è®¾ç½®ç»“æœé¡µéŸ³ä¹å›¾æ ‡ä½ç½®ï¼ŒåŒæ ·æ˜¯ç›¸å¯¹äºèƒŒæ™¯å®¹å™¨
        resultMusicIcon.style.cssText = `
          position: absolute !important;
          top: 40px !important;
          right: 40px !important;
          width: 40px !important;
          height: 40px !important;
          background: url("./music.png") no-repeat center !important;
          background-size: contain !important;
          z-index: 9999 !important;
          cursor: pointer !important;
          display: block !important;
          visibility: visible !important;
          opacity: 1 !important;
        `;
        
        // åŒæ­¥ä¸»é¡µé¢éŸ³ä¹å›¾æ ‡çŠ¶æ€
        if (mainMusicIcon) {
          if (mainMusicIcon.classList.contains('music1')) {
            resultMusicIcon.classList.add('music1');
          }
        }
        
        console.log('ğŸµ ç»“æœé¡µéŸ³ä¹å›¾æ ‡å·²è®¾ç½®å®Œæˆ');
      }
    });
    
    // ==================== ä¿®å¤ï¼šä¸ºçº¿å›¢æ·»åŠ ç§»åŠ¨ç«¯è§¦æ‘¸æ‹–åŠ¨æ”¯æŒ ====================
    // è¿™äº›ä»£ç ä»…æ·»åŠ è§¦æ‘¸æ”¯æŒï¼Œä¸ä¿®æ”¹ä»»ä½•åŸæœ‰åŠŸèƒ½
    
    // ä¸ºæ¯ä¸ªçº¿å›¢æ·»åŠ è§¦æ‘¸æ‹–åŠ¨æ”¯æŒ
    allThreads.forEach(thread => {
      // åªåœ¨ç§»åŠ¨ç«¯æ·»åŠ è§¦æ‘¸æ‹–åŠ¨ï¼Œä¸å½±å“æ¡Œé¢ç«¯
      let touchStartX, touchStartY;
      let isTouchDragging = false;
      let originalX, originalY;
      
      thread.addEventListener('touchstart', function(e) {
        e.preventDefault();
        
        // ä¿å­˜è§¦æ‘¸å¼€å§‹ä½ç½®
        const touch = e.touches[0];
        touchStartX = touch.clientX;
        touchStartY = touch.clientY;
        
        // ä¿å­˜åŸå§‹ä½ç½®
        const rect = this.getBoundingClientRect();
        originalX = rect.left;
        originalY = rect.top;
        
        // è®¾ç½®è§¦æ‘¸çŠ¶æ€
        isTouchDragging = true;
        currentThreadType = this.dataset.type;
        
        // æ·»åŠ è§†è§‰åé¦ˆ
        this.style.opacity = '0.7';
        this.style.zIndex = '1001';
        this.style.transform = 'scale(0.95)';
        
        console.log(`ğŸ‘‰ è§¦æ‘¸å¼€å§‹æ‹–åŠ¨ï¼š${currentThreadType}çº¿å›¢`);
      });
      
      thread.addEventListener('touchmove', function(e) {
        if (!isTouchDragging) return;
        e.preventDefault();
        
        const touch = e.touches[0];
        const deltaX = touch.clientX - touchStartX;
        const deltaY = touch.clientY - touchStartY;
        
        // ç§»åŠ¨çº¿å›¢è·Ÿéšæ‰‹æŒ‡
        this.style.transform = `translate(${deltaX}px, ${deltaY}px) scale(0.95)`;
        
        // æ£€æŸ¥æ˜¯å¦ç§»åŠ¨åˆ°ç›®æ ‡åŒºåŸŸä¸Šæ–¹
        checkTouchOverTarget(touch.clientX, touch.clientY);
      });
      
      thread.addEventListener('touchend', function(e) {
        if (!isTouchDragging) return;
        e.preventDefault();
        
        const touch = e.changedTouches[0];
        
        // é‡ç½®æ ·å¼
        this.style.opacity = '';
        this.style.zIndex = '';
        this.style.transform = '';
        
        // æ£€æŸ¥æ”¾ç½®ä½ç½®
        checkTouchDrop(touch.clientX, touch.clientY, currentThreadType);
        
        // é‡ç½®çŠ¶æ€
        isTouchDragging = false;
        console.log(`ğŸ‘‹ è§¦æ‘¸ç»“æŸï¼š${currentThreadType}çº¿å›¢`);
      });
    });
    
    // æ£€æŸ¥è§¦æ‘¸æ˜¯å¦åœ¨ç›®æ ‡åŒºåŸŸä¸Šæ–¹
    function checkTouchOverTarget(x, y) {
      const targets = [triggerSide1, triggerSide2, triggerMiddle];
      
      targets.forEach(target => {
        const rect = target.getBoundingClientRect();
        if (x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom) {
          target.style.backgroundColor = 'rgba(255, 255, 255, 0.2)';
        } else {
          target.style.backgroundColor = '';
        }
      });
    }
    
    // æ£€æŸ¥è§¦æ‘¸æ”¾ç½®ä½ç½®å¹¶è§¦å‘åŸæœ‰åŠŸèƒ½
    function checkTouchDrop(x, y, threadType) {
      if (!threadType) return;
      
      // é‡ç½®æ‰€æœ‰ç›®æ ‡åŒºåŸŸæ ·å¼
      [triggerSide1, triggerSide2, triggerMiddle].forEach(target => {
        target.style.backgroundColor = '';
      });
      
      // æ£€æŸ¥æ˜¯å¦æ”¾ç½®åˆ°ç›®æ ‡åŒºåŸŸ
      const targets = [
        { element: triggerSide1, type: 'side' },
        { element: triggerSide2, type: 'side' },
        { element: triggerMiddle, type: 'middle' }
      ];
      
      targets.forEach(target => {
        const rect = target.element.getBoundingClientRect();
        
        if (x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom) {
          console.log(`ğŸ¯ çº¿å›¢æ”¾ç½®åˆ°${target.type}åŒºåŸŸ`);
          
          // è§¦å‘åŸæœ‰çš„æ›´æ–°å‡½æ•°
          if (target.type === 'side') {
            debounceUpdateSide(threadType);
          } else if (target.type === 'middle') {
            debounceUpdateMiddle(threadType);
          }
        }
      });
      
      // é‡ç½®å½“å‰çº¿å›¢ç±»å‹
      currentThreadType = '';
    }
    
    // ä¸ºè§¦å‘åŒºåŸŸæ·»åŠ è§¦æ‘¸åé¦ˆ
    [triggerSide1, triggerSide2, triggerMiddle].forEach(trigger => {
      trigger.addEventListener('touchstart', function(e) {
        e.preventDefault();
        this.style.backgroundColor = 'rgba(255, 255, 255, 0.3)';
      });
      
      trigger.addEventListener('touchend', function(e) {
        e.preventDefault();
        this.style.backgroundColor = '';
      });
    });
    
    // ==================== ä¸ºå…¶ä»–å…ƒç´ æ·»åŠ è§¦æ‘¸æ”¯æŒ ====================
    
    // ä¸ºä¸‹ä¸€æ­¥æŒ‰é’®æ·»åŠ è§¦æ‘¸æ”¯æŒ
    nextImg.addEventListener('touchstart', (e) => {
      e.preventDefault();
      nextImg.click();
    });
    
    resultNextBtn.addEventListener('touchstart', (e) => {
      e.preventDefault();
      resultNextBtn.click();
    });
    
    // ä¸ºé€æ˜å±‚æ·»åŠ è§¦æ‘¸æ”¯æŒ
    coverTouming.addEventListener('touchstart', (e) => {
      e.preventDefault();
      coverTouming.click();
    });
    
    resultCoverTouming.addEventListener('touchstart', (e) => {
      e.preventDefault();
      resultCoverTouming.click();
    });
    
    // ä¸ºå·¥å…·æ·»åŠ è§¦æ‘¸æ”¯æŒ
    [zongmaoshuaImg, tongsiImg, xianpaijianImg].forEach(tool => {
      tool.addEventListener('touchstart', (e) => {
        e.preventDefault();
        tool.click();
      });
    });
    
    // ä¸ºå¤§çº¿æ’å‰ªæ·»åŠ è§¦æ‘¸æ”¯æŒ
    xianpaijianBigImg.addEventListener('touchstart', (e) => {
      e.preventDefault();
      xianpaijianBigImg.click();
    });
    
    // ä¸ºéŸ³ä¹å›¾æ ‡æ·»åŠ è§¦æ‘¸æ”¯æŒ
    mainMusicIcon.addEventListener('touchstart', function(e) {
      e.preventDefault();
      this.click();
    });
    
    resultMusicIcon.addEventListener('touchstart', function(e) {
      e.preventDefault();
      this.click();
    });
    
    // é˜»æ­¢ç§»åŠ¨ç«¯é»˜è®¤æ»šåŠ¨
    document.addEventListener('touchmove', function(e) {
      if (e.target.classList.contains('thread') || 
          e.target.classList.contains('result-tool-img') ||
          e.target.id === 'xianpaijianBigImg') {
        e.preventDefault();
      }
    }, { passive: false });
    
    console.log('ğŸ“± ç§»åŠ¨ç«¯è§¦å±åŠŸèƒ½å·²æ·»åŠ ï¼Œçº¿å›¢å¯ä»¥è§¦æ‘¸æ‹–åŠ¨');
    
    // ==================== ä¿®å¤ï¼šç¡®ä¿ç»“æœé¡µå·¥å…·å¯ç”¨ ====================
    // åœ¨é¡µé¢åˆ‡æ¢åé‡æ–°ç»‘å®šå·¥å…·äº‹ä»¶
    
    // ç›‘å¬é¡µé¢æ˜¾ç¤ºå˜åŒ–ï¼Œç¡®ä¿ç»“æœé¡µåŠŸèƒ½æ­£å¸¸
    document.addEventListener('visibilitychange', function() {
      if (!document.hidden && resultPage.style.display === 'block') {
        console.log('ğŸ” ç»“æœé¡µé‡æ–°æ¿€æ´»ï¼Œç¡®ä¿åŠŸèƒ½æ­£å¸¸');
        
        // ç¡®ä¿æ‰€æœ‰å·¥å…·å…ƒç´ å¯è§
        [zongmaoshuaImg, tongsiImg, xianpaijianImg].forEach(tool => {
          if (tool) {
            tool.style.display = 'block';
            tool.style.visibility = 'visible';
            tool.style.opacity = '1';
            tool.style.pointerEvents = 'auto';
          }
        });
      }
    });
  </script>
</body>
</html>